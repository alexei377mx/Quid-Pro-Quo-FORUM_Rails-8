<section class="section">
  <div class="container">
    <div class="content">
      <h1 class="title is-2"><%= @post.title %></h1>
      <br>
      <div class="columns">
        <div class="column">
          <div class="icon-text">
            <span class="icon"><i class="fa-solid fa-user"></i></span>
            <span>Publicado por <strong><%= @post.user.name %></strong></span>
          </div>
        </div>

        <div class="column">
          <div class="icon-text">
            <span class="icon"><i class="fa-solid fa-calendar-days"></i></span>
            <span><%= post_published_time(@post) %></span>
          </div>
        </div>
        <% if @post.updated_at > @post.created_at %>
          <div class="column">
            <span class="icon"><i class="fa-solid fa-pen-to-square"></i></span>
            <span><%= post_edited_time(@post) %></span>
          </div>
        <% end %>

        <div class="column">
          <div class="icon-text">
            <span class="icon"><i class="fa-solid fa-tag"></i></span>
            <span><strong>Categoría:</strong> <%= @post.category %></span>
          </div>
        </div>
      </div>

      <div class="buttons are-small">
        <% if can_edit_post?(@post) %>
          <%= link_to edit_post_path(@post), class: "button is-warning" do %>
            <span class="icon"><i class="fa-solid fa-pen-to-square"></i></span>
            <span>Editar</span>
          <% end %>
        <% end %>
        <% if user_signed_in? %>
          <%= link_to new_post_report_path(@post), class: "button is-danger" do %>
            <span class="icon"><i class="fa-solid fa-flag"></i></span>
            <span>Reportar</span>
          <% end %>
        <% end %>

        <% if can? :admin_destroy_post, @post and !@post.deleted_by_admin? %>
          <%= button_to admin_destroy_post_post_path(@post), method: :patch,
              data: { confirm: "¿Estás seguro de eliminar esta publicación como administrador?" },
              class: "button is-danger" do %>
            <span class="icon"><i class="fa-solid fa-ban"></i></span>
            <span>Eliminar (admin)</span>
          <% end %>
        <% end %>
      </div>

      <hr>
      <div class="box">
        <div class="content post-content">
          <%= simple_format(@post.content) %>
        </div>
      </div>

      <div class="comments mt-5">
        <h2 class="subtitle is-4"><i class="fa-solid fa-comments"></i> Comentarios</h2>

        <% if @comments.any? %>
          <% @comments.each do |comment| %>
            <%= render partial: "comments/comment", locals: { comment: comment, post: @post } %>
          <% end %>
        <% else %>
          <p><i class="fa-solid fa-circle-info"></i> No hay comentarios aún.</p>
        <% end %>

        <% if user_signed_in? %>
          <article class="media">
            <figure class="media-left">
              <p class="image is-64x64">
                <img src="https://bulma.io/assets/images/placeholders/128x128.png" />
              </p>
            </figure>
            <div class="media-content">
              <%= form_with(model: [ @post, (@comment || @post.comments.build) ], local: true) do |form| %>
                <div class="field">
                  <%= form.label :content, class: "label" do %>
                    <span class="icon-text">
                      <span class="icon"><i class="fa-solid fa-comment"></i></span>
                      <span>Comentario</span>
                    </span>
                  <% end %>
                  <div class="control">
                    <%= form.text_area :content, class: "textarea #{(@comment && @comment.errors[:content].any?) ? 'is-danger' : ''}", placeholder: "Agregar un comentario..." %>
                  </div>
                  <small class="help is-danger"><%= (@comment && @comment.errors[:content].join(', ')) %></small>
                </div>
                <div class="field">
                  <p class="control">
                    <%= button_tag type: 'submit', class: "button is-info" do %>
                      <i class="fa-solid fa-paper-plane"></i> Publicar comentario
                    <% end %>
                  </p>
                </div>
              <% end %>
            </div>
          </article>
        <% else %>
          <p><%= link_to "<i class='fa-solid fa-right-to-bracket'></i> Inicia sesión".html_safe, login_path, data: { turbo: false } %> para dejar un comentario.</p>
        <% end %>
      </div>
    </div>
  </div>
</section>