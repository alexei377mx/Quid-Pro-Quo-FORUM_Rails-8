<section class="section">
  <div class="container">
    <div class="content">
      <h1 class="title is-2"><%= @post.title %></h1>
      <br>
      <div class="subtitle is-6 has-text-grey mb-5">
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-user"></i>
          </span>
          <span>Publicado por <strong><%= @post.user.name %></strong></span>
        </span>
        <span class="icon-text ml-4">
          <span class="icon">
            <i class="fas fa-calendar-alt"></i>
          </span>
          <span>hace <%= time_ago_in_words(@post.created_at) %></span>
        </span>
        <% if @post.updated_at > @post.created_at %>
          <span class="icon-text ml-4">
            <span class="icon">
              <i class="fas fa-edit"></i>
            </span>
            <span>Editado hace <%= time_ago_in_words(@post.updated_at) %></span>
          </span>
        <% end %>
      </div>

      <% if user_signed_in? && @post.user == current_user %>
        <div class="buttons are-small">
          <%= link_to edit_post_path(@post), class: "button is-warning" do %>
            <span class="icon">
              <i class="fas fa-edit"></i>
            </span>
            <span>Editar</span>
          <% end %>
        </div>
      <% end %>

      <hr>
      <div class="box">
        <div class="content post-content">
          <%= simple_format(@post.content) %>
        </div>
      </div>

      <div class="comments mt-5">
        <h2 class="subtitle is-4">Comentarios</h2>

        <% if @post.comments.order(created_at: :desc).any? %>
          <% @post.comments.order(created_at: :desc).each do |comment| %>
            <article class="media">
              <figure class="media-left">
                <p class="image is-64x64">
                  <img src="https://bulma.io/assets/images/placeholders/128x128.png" />
                </p>
              </figure>
              <div class="media-content">
                <div class="content">
                  <p>
                    <strong><%= comment.user.name %></strong>
                    <br />
                    <%= comment.content %>
                    <br />
                    <small> hace 
                      <%= time_ago_in_words(comment.created_at) %>
                      <% if comment.updated_at > comment.created_at %>
                        <span> · Editado hace <%= time_ago_in_words(comment.updated_at) %></span>
                      <% end %>
                      <% if user_signed_in? && comment.user == current_user %>
                        · <%= link_to "Editar", edit_post_comment_path(@post, comment) %>
                      <% end %>
                      · <%= link_to "Responder", "#", onclick: "document.getElementById('reply-form-#{comment.id}').style.display='block'; return false;" %>
                    </small>
                  </p>
                </div>

                <% if user_signed_in? %>
                  <div id="reply-form-<%= comment.id %>" style="display: none;">
                    <%= form_with(model: [ @post, Comment.new(parent_id: comment.id) ], url: reply_post_comment_path(@post, comment), local: true) do |form| %>
                      <div class="field">
                        <p class="control">
                          <%= form.text_area :content, class: "textarea", placeholder: "Agregar una respuesta..." %>
                        </p>
                      </div>
                      <div class="field">
                        <p class="control">
                          <%= form.submit "Publicar respuesta", class: "button is-info" %>
                        </p>
                      </div>
                    <% end %>
                  </div>
                <% end %>

                <% if comment.replies.any? %>
                  <% comment.replies.order(created_at: :desc).each do |reply| %>
                    <article class="media">
                      <figure class="media-left">
                        <p class="image is-48x48">
                          <img src="https://bulma.io/assets/images/placeholders/96x96.png" />
                        </p>
                      </figure>
                      <div class="media-content">
                        <div class="content">
                          <p>
                            <strong><%= reply.user.name %></strong>
                            <br />
                            <%= reply.content %>
                            <br />
                            <small>
                              <%= time_ago_in_words(reply.created_at) %> atrás
                              <% if reply.updated_at > reply.created_at %>
                                <span> · Editado hace <%= time_ago_in_words(reply.updated_at) %></span>
                              <% end %>
                              <% if user_signed_in? && reply.user == current_user %>
                                · <%= link_to "Editar", edit_post_comment_path(@post, reply) %>
                              <% end %>
                            </small>
                          </p>
                        </div>
                      </div>
                    </article>
                  <% end %>
                <% end %>
              </div>
            </article>
          <% end %>
        <% else %>
          <p>No hay comentarios aún.</p>
        <% end %>

        <% if user_signed_in? %>
          <article class="media">
            <figure class="media-left">
              <p class="image is-64x64">
                <img src="https://bulma.io/assets/images/placeholders/128x128.png" />
              </p>
            </figure>
            <div class="media-content">
              <%= form_with(model: [ @post, @post.comments.build ], local: true) do |form| %>
                <div class="field">
                  <p class="control">
                    <%= form.text_area :content, class: "textarea", placeholder: "Agregar un comentario..." %>
                  </p>
                </div>
                <div class="field">
                  <p class="control">
                    <%= form.submit "Publicar comentario", class: "button is-info" %>
                  </p>
                </div>
              <% end %>
            </div>
          </article>
        <% else %>
          <p><%= link_to "Inicia sesión", login_path %> para dejar un comentario.</p>
        <% end %>
      </div>
    </div>
  </div>
</section>