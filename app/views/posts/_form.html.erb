<%= form_with(model: post, html: { class: "box", multipart: true }) do |form| %>
  <div class="field">
    <%= form.label :title, class: "label" do %>
      <span class="icon-text">
        <span class="icon">
          <i class="fa-solid fa-heading"></i>
        </span>
        <span>Título</span>
      </span>
    <% end %>
    <div class="control has-icons-left">
      <% if post.persisted? %>
        <%= form.text_field :title, class: "input", disabled: true %>
        <%= form.hidden_field :title %>
      <% else %>
        <%= form.text_field :title, class: "input #{'is-danger' if post.errors[:title].any?}", placeholder: "Título del post (mínimo 5 caracteres)" %>
      <% end %>
      <span class="icon is-small is-left">
        <i class="fa-solid fa-pen"></i>
      </span>
    </div>
    <small class="help is-danger"><%= post.errors[:title].join(', ') %></small>
  </div>

  <div class="field">
    <%= form.label :content, class: "label" do %>
      <span class="icon-text">
        <span class="icon">
          <i class="fa-solid fa-align-left"></i>
        </span>
        <span>Contenido</span>
      </span>
      <p class="help">
        Puedes usar <strong>Markdown</strong>. 
        <%= link_to "Ver guía de sintaxis", "https://www.markdownguide.org/basic-syntax/", target: "_blank", rel: "noopener", class: "has-text-info" %>
      </p>
    <% end %>
    <div class="control">
      <%= form.text_area :content, rows: 10, class: "textarea #{'is-danger' if post.errors[:content].any?}", placeholder: "Escribe el contenido detallado del post..." %>
    </div>
    <small class="help is-danger"><%= post.errors[:content].join(', ') %></small>
  </div>

  <div class="field">
    <%= form.label :category, class: "label" do %>
      <span class="icon-text">
        <span class="icon">
          <i class="fa-solid fa-tags"></i>
        </span>
        <span>Categoría</span>
      </span>
    <% end %>
    <div class="select">
      <% if post.persisted? %>
        <%= form.select :category, Post::CATEGORIES.sort, {}, disabled: true, class: "select" %>
        <%= form.hidden_field :category %>
      <% else %>
        <%= form.select :category, Post::CATEGORIES.sort, { prompt: "Selecciona una categoría" }, class: "select #{'is-danger' if post.errors[:category].any?}" %>
      <% end %>
    </div>
    <small class="help is-danger"><%= post.errors[:category].join(', ') %></small>
  </div>

  <div class="field">
    <%= form.label :image, class: "label" do %>
      <span class="icon-text">
        <span class="icon"><i class="fa-solid fa-image"></i></span>
        <span>Imagen del post</span>
      </span>
    <% end %>

    <% if post.image.attached? && post.image.image? %>
      <div class="mb-4 card box">
        <p class="has-text-weight-semibold">Imagen actual:</p>

        <div class="">
          <figure class="image is-128x128 is-inline-block">
            <%= image_tag(post.image.variant(resize_to_limit: [128, 128])) %>
          </figure>

          <div class="mt-2">
            <label class="checkbox">
              <%= form.check_box :remove_image %> Eliminar imagen
            </label>
          </div>
        </div>
      </div>
    <% end %>

    <div class="file has-name is-fullwidth mt-2" data-controller="file-input">
      <label class="file-label">
        <%= form.file_field :image, class: "file-input", accept: "image/*",
              data: {
                file_input_target: "input",
                action: "change->file-input#updateFileName"
              } %>
        <span class="file-cta">
          <span class="file-icon">
            <i class="fa-solid fa-upload"></i>
          </span>
          <span class="file-label">
            Selecciona una imagen…
          </span>
        </span>
        <span class="file-name" id="file-name" data-file-input-target="fileName">
          No hay archivo seleccionado
        </span>
      </label>
    </div>

    <% if post.errors[:image].present? %>
      <small class="help is-danger"><%= post.errors[:image].join(', ') %></small>
    <% end %>
  </div>


  <div class="field is-grouped mt-5">
    <div class="control">
      <%= button_tag type: 'submit', class: "button is-primary" do %>
        <span class="icon">
          <i class="fa-solid fa-save"></i>
        </span>
        <span>
          <%= post.persisted? ? "Actualizar publicación" : "Crear publicación" %>
        </span>
      <% end %>
    </div>
    <% cancel_path = post.persisted? ? post_path(post) : posts_path %>
    <div class="control">
      <%= link_to cancel_path, class: "button" do %>
        <span class="icon">
          <i class="fa-solid fa-times"></i>
        </span>
        <span>Cancelar</span>
      <% end %>
    </div>
  </div>
<% end %>